<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Offline Map</title>
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; width: 100%; margin: 0; background: #0d0d0d; }
    body { min-height: 100vh; }
    body, #map { display: block; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  const params = new URLSearchParams(window.location.search);
  const googleMapsKey = params.get('google_key')?.trim() ?? '';

  const leafletOptions = {
    zoomControl: true,
    attributionControl: false,
    minZoom: 0,
    maxZoom: 19
  };

  const tileLayerOptions = {
    minZoom: 0,
    maxZoom: 19,
    tileSize: 256,
    noWrap: true
  };

  const droneColors = {
    freyja: '#f49221',
    cleo: '#69e36b'
  };

  const droneMarkers = {};
  let currentMap = null;
  let mapMode = null;

  function _focusMapOn(lat, lon) {
    if (!currentMap || currentMap.__hasCentered) {
      return;
    }

    if (mapMode === 'leaflet') {
      currentMap.setView([lat, lon], 14, { animate: true });
    } else if (mapMode === 'google') {
      currentMap.setCenter({ lat, lng: lon });
      currentMap.setZoom(14);
    }

    currentMap.__hasCentered = true;
  }

  function _updateLeafletMarker(droneId, lat, lon) {
    const position = [lat, lon];
    const color = droneColors[droneId] ?? '#ffffff';
    const existing = droneMarkers[droneId];

    if (existing) {
      existing.setLatLng(position);
    } else {
      const marker = L.circleMarker(position, {
        radius: 8,
        color,
        weight: 3,
        fillColor: color,
        fillOpacity: 0.9
      });
      marker.addTo(currentMap);
      marker.bindTooltip(`<strong style="color:${color}">${droneId}</strong>`, {
        permanent: true,
        direction: 'top',
        offset: [0, -12]
      });
      droneMarkers[droneId] = marker;
    }

    _focusMapOn(lat, lon);
  }

  function _updateGoogleMarker(droneId, lat, lon) {
    const position = { lat, lng: lon };
    const color = droneColors[droneId] ?? '#ffffff';
    const existing = droneMarkers[droneId];

    if (existing) {
      existing.setPosition(position);
    } else {
      const marker = new google.maps.Marker({
        position,
        map: currentMap,
        title: droneId,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 9,
          strokeWeight: 2,
          strokeColor: '#111',
          fillColor: color,
          fillOpacity: 1
        }
      });
      droneMarkers[droneId] = marker;
    }

    _focusMapOn(lat, lon);
  }

  function _updateDroneMarkerOnMap(droneId, lat, lon) {
    if (mapMode === 'leaflet') {
      _updateLeafletMarker(droneId, lat, lon);
    } else if (mapMode === 'google') {
      _updateGoogleMarker(droneId, lat, lon);
    }
  }

  function _registerLeaflet(map) {
    currentMap = map;
    mapMode = 'leaflet';
    window.updateDroneMarker = _updateDroneMarkerOnMap;
  }

  function _registerGoogle(map) {
    currentMap = map;
    mapMode = 'google';
    window.updateDroneMarker = _updateDroneMarkerOnMap;
  }

  window.updateDroneMarker = () => {
    console.warn('Map not ready; marker ignored');
  };

  function createLeafletMap() {
    const map = L.map('map', leafletOptions).setView([0, 0], 2);
    L.tileLayer('http://127.0.0.1:8000/{z}/{x}/{y}', tileLayerOptions).addTo(map);
    _registerLeaflet(map);
    window.setCenter = function(lat, lon) {
      map.setView([lat, lon], map.getZoom());
    };
  }

  function initGoogleMap() {
    const googleMap = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 0, lng: 0 },
      zoom: 2,
      minZoom: 0,
      maxZoom: 19,
      disableDefaultUI: true,
      mapTypeId: google.maps.MapTypeId.SATELLITE
    });
    _registerGoogle(googleMap);
    window.setCenter = function(lat, lon) {
      googleMap.setCenter({ lat, lng: lon });
    };
  }

  if (googleMapsKey) {
    window.initGoogleMap = initGoogleMap;
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(googleMapsKey)}&callback=initGoogleMap`;
    script.async = true;
    script.defer = true;
    script.onerror = () => {
      console.warn('Failed to load Google Maps SDK, falling back to offline tiles.');
      createLeafletMap();
    };
    document.head.appendChild(script);
  } else {
    console.warn('GOOGLE_MAPS_KEY missing; falling back to bundled MBTiles.');
    createLeafletMap();
  }
</script>

</body>
</html>